#!/bin/bash
SESSION_NAME="$1"
WINDOW_INDEX="$2"
NO_ATTACH="$3"

if [ -z "$SESSION_NAME" ]; then
    echo "Usage: $0 <session_name> [window_index] [--no-attach]"
    exit 1
fi

# Ensure session exists with correct layout if it doesn't exist at all
if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    DEFAULT_LOADER="tmux-session-default-layout"
    if command -v "${DEFAULT_LOADER}-local" >/dev/null 2>&1; then
        DEFAULT_LOADER="${DEFAULT_LOADER}-local"
    fi

    if command -v "$DEFAULT_LOADER" >/dev/null 2>&1; then
        SESSION_NAME="$SESSION_NAME" "$DEFAULT_LOADER"
    else
        SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
        DEFAULT_LOADER_PATH="${SCRIPT_DIR}/${DEFAULT_LOADER}"
        if [ ! -x "$DEFAULT_LOADER_PATH" ]; then
            echo "Error: ${DEFAULT_LOADER} not found in PATH or ${SCRIPT_DIR}." >&2
            exit 1
        fi
        SESSION_NAME="$SESSION_NAME" "$DEFAULT_LOADER_PATH"
    fi
fi

# Switch window globally for the session
if [ -n "$WINDOW_INDEX" ]; then
    tmux select-window -t "${SESSION_NAME}:${WINDOW_INDEX}"
fi

# Check if we should exit without attaching
if [ "$NO_ATTACH" == "--no-attach" ]; then
    exit 0
fi

# Attach logic
if [ -n "$TMUX" ]; then
    # We are inside tmux. Switch client to this session if needed.
    CURRENT_SESSION=$(tmux display-message -p '#S')
    if [ "$CURRENT_SESSION" != "$SESSION_NAME" ]; then
         tmux switch-client -t "$SESSION_NAME"
    fi
else
    # We are outside tmux (e.g., standard VS Code terminal task).
    # Attach to the session.
    # 'new-session -A' attaches to the existing session.
    exec tmux new-session -A -s "$SESSION_NAME"
fi
