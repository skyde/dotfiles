#!/bin/bash
set -e

echo "Running formatting..."
git cl format

echo "Staging files..."

# 1. Stage new (untracked) files
# Added -r to xargs to prevent errors if no new files exist
git ls-files -z --others --exclude-standard | xargs -0 -r git add

# 2. Stage modified files, BUT EXCLUDE submodules
# We use 'git diff' to list modified files, explicitly telling it to ignore submodules.
# We pipe that list to 'git add'.
git diff -z --name-only --ignore-submodules=all | xargs -0 -r git add

echo "Amending commit..."
# If nothing was staged (e.g. only submodules changed), this might verify emptiness.
# --allow-empty allows the script to pass even if no code changes were made (just formatting).
git commit --amend --no-edit

echo "Uploading..."
git cl upload -d -T "$@"
