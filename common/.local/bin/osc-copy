#!/usr/bin/env bash
set -euo pipefail

# Copy stdin to the system clipboard using OSC 52 or native clipboard tools.
# Falls back to printing when no suitable channel is available.

input=$(cat)

# Prefer the native clipboard on local macOS sessions when available.
if [[ -n "$input" ]] && command -v pbcopy >/dev/null 2>&1 && [[ -z "${SSH_CONNECTION:-}" ]]; then
  copier=(pbcopy)
  if command -v reattach-to-user-namespace >/dev/null 2>&1; then
    copier=(reattach-to-user-namespace pbcopy)
  fi

  if printf '%s' "$input" | "${copier[@]}"; then
    exit 0
  fi
fi

# If we don't have a TTY to target, just print the contents.
if [[ ! -t 1 && ! -w /dev/tty ]]; then
  printf '%s\n' "$input"
  exit 0
fi

encoded=$(printf '%s' "$input" | base64 | tr -d '\n')
out="/dev/tty"

if [[ -n "${TMUX:-}" ]]; then
  printf "\033Ptmux;\033\033]52;c;%s\a\033\\" "$encoded" >"$out"
else
  printf "\033]52;c;%s\a" "$encoded" >"$out"
fi
