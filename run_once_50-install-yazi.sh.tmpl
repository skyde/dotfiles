#!/usr/bin/env bash
set -euo pipefail

# Ensure Yazi works out-of-the-box:
# - Install yazi (brew/apt or cargo fallback)
# - Ensure ripgrep/bat/fd are installed
# - Create aliases for Debian's batcat/fdfind
# - Put yazi/ya on PATH via symlinks if installed via cargo

HAVE() { command -v "$1" >/dev/null 2>&1; }

SUDO_CMD=""
if [ "$(id -u)" -ne 0 ] && HAVE sudo; then
  SUDO_CMD="sudo"
fi

OS="$(uname -s)"

ensure_symlink() {
  local target="$1" link_path="$2"
  if [ -e "$target" ]; then
    if [ ! -e "$link_path" ]; then
      $SUDO_CMD ln -s "$target" "$link_path"
    fi
  fi
}

# Try to source shared helpers (truthy/ask) if available
if [ -n "${CHEZMOI_SOURCE_DIR:-}" ] && [ -f "$CHEZMOI_SOURCE_DIR/lib/run_ensure.sh" ]; then
  # shellcheck disable=SC1090
  . "$CHEZMOI_SOURCE_DIR/lib/run_ensure.sh"
fi

# Fallback implementations if not sourced
_truthy() {
  case "${1:-}" in
    1|true|TRUE|True|yes|YES|Yes|on|ON|On) return 0 ;;
    *) return 1 ;;
  esac
}

is_tty() { [ -t 0 ] && [ -t 1 ]; }

ask() {
  local prompt="$1"
  if ! is_tty; then
    echo "[skip] $prompt (non-interactive; default = no)"
    return 1
  fi
  read -r -p "$prompt [y/N] " reply
  [[ "$reply" =~ ^([yY]|[yY][eE][sS])$ ]]
}

confirm_yazi_install() {
  local method_msg="$1"
  if _truthy "${AUTO_INSTALL:-}"; then
    echo "[auto] Install yazi via $method_msg (AUTO_INSTALL=1)"
    return 0
  fi
  ask "Install yazi now via $method_msg?"
}

install_with_cargo() {
  # Skip if already installed
  if HAVE yazi || [ -x "$HOME/.cargo/bin/yazi" ]; then
    return
  fi
  # Install Rust toolchain non-interactively, then build Yazi
  if ! HAVE cargo; then
    curl -fsSL https://sh.rustup.rs | sh -s -- -y
    # shellcheck disable=SC1090
    . "$HOME/.cargo/env"
  fi
  cargo install --locked yazi-fm yazi-cli

  # Symlink yazi + ya to a root-owned bin to avoid PATH issues
  if [ -x "$HOME/.cargo/bin/yazi" ]; then
    $SUDO_CMD ln -sf "$HOME/.cargo/bin/yazi" /usr/local/bin/yazi
  fi
  if [ -x "$HOME/.cargo/bin/ya" ]; then
    $SUDO_CMD ln -sf "$HOME/.cargo/bin/ya" /usr/local/bin/ya
  fi
}

install_from_github() {
  # Install prebuilt Yazi binaries from GitHub releases (avoids compilation)
  # Requires: curl, tar; prefers jq for asset selection when available
  local repo="sxyazi/yazi"
  local os_arch_triple=""
  local uname_s="$(uname -s)"
  local uname_m="$(uname -m)"

  case "$uname_s" in
    Linux)
      case "$uname_m" in
        x86_64) os_arch_triple="x86_64-unknown-linux-gnu" ;;
        aarch64|arm64) os_arch_triple="aarch64-unknown-linux-gnu" ;;
        *) echo "Unsupported Linux arch: $uname_m" >&2; return 1 ;;
      esac
      ;;
    Darwin)
      case "$uname_m" in
        x86_64) os_arch_triple="x86_64-apple-darwin" ;;
        arm64) os_arch_triple="aarch64-apple-darwin" ;;
        *) echo "Unsupported macOS arch: $uname_m" >&2; return 1 ;;
      esac
      ;;
    *)
      echo "Unsupported OS: $uname_s" >&2; return 1 ;;
  esac

  local tag="${YAZI_VERSION:-}"
  if [ -z "$tag" ]; then
    # Fetch latest tag via GitHub API
    if command -v jq >/dev/null 2>&1; then
      tag="$(curl -fsSL "https://api.github.com/repos/${repo}/releases/latest" | jq -r .tag_name)"
    else
      # Fallback: scrape tag_name with sed (best effort)
      tag="$(curl -fsSL "https://api.github.com/repos/${repo}/releases/latest" 2>/dev/null | sed -n 's/.*"tag_name"\s*:\s*"\([^"]\+\)".*/\1/p' | head -n1)"
    fi
  fi
  if [ -z "$tag" ] || [ "$tag" = "null" ]; then
    echo "Failed to determine latest Yazi release tag" >&2
    return 1
  fi

  # Locate asset matching our triple
  local asset_url=""
  if command -v jq >/dev/null 2>&1; then
    asset_url="$(
      curl -fsSL "https://api.github.com/repos/${repo}/releases/tags/${tag}" \
        | jq -r --arg t "$os_arch_triple" '.assets[] | select(.browser_download_url | test($t)) | .browser_download_url' \
        | grep -E '\.(tar\.(gz|xz)|zip)$' \
        | head -n1
    )"
  fi

  if [ -z "$asset_url" ] || [ "$asset_url" = "null" ]; then
    # Guess common filename pattern if jq isn't available or selection failed
    # Patterns seen: yazi-<tag>-<triple>.tar.gz or yazi-<triple>.tar.gz
    asset_url="https://github.com/${repo}/releases/download/${tag}/yazi-${tag}-${os_arch_triple}.tar.gz"
    if ! curl -fsI "$asset_url" >/dev/null 2>&1; then
      asset_url="https://github.com/${repo}/releases/download/${tag}/yazi-${os_arch_triple}.tar.gz"
    fi
  fi

  if ! curl -fsI "$asset_url" >/dev/null 2>&1; then
    echo "Could not find a matching Yazi release asset for $os_arch_triple at tag $tag" >&2
    return 1
  fi

  local tmp_dir
  tmp_dir="$(mktemp -d)"
  trap 'rm -rf "$tmp_dir"' EXIT

  # Download to appropriate filename based on extension
  local archive_ext
  case "$asset_url" in
    *.zip) archive_ext="zip" ;;
    *.tar.gz) archive_ext="tar.gz" ;;
    *.tar.xz) archive_ext="tar.xz" ;;
    *) archive_ext="unknown" ;;
  esac
  local archive="$tmp_dir/yazi.$archive_ext"
  curl -fsSL "$asset_url" -o "$archive"

  # Extract
  mkdir -p "$tmp_dir/extract"
  case "$archive_ext" in
    zip)
      if command -v unzip >/dev/null 2>&1; then
        unzip -q "$archive" -d "$tmp_dir/extract"
      elif command -v bsdtar >/dev/null 2>&1; then
        bsdtar -xf "$archive" -C "$tmp_dir/extract"
      else
        echo "Need 'unzip' or 'bsdtar' to extract Yazi zip archive" >&2
        return 1
      fi
      ;;
    tar.gz)
      tar -xzf "$archive" -C "$tmp_dir/extract" ;;
    tar.xz)
      tar -xJf "$archive" -C "$tmp_dir/extract" ;;
    *)
      echo "Unknown archive type for $asset_url" >&2
      return 1 ;;
  esac

  # Find binaries (yazi, ya) within extraction
  local yazi_bin
  yazi_bin="$(find "$tmp_dir/extract" -type f -name yazi -perm -u+x | head -n1 || true)"
  local ya_bin
  ya_bin="$(find "$tmp_dir/extract" -type f -name ya -perm -u+x | head -n1 || true)"
  if [ -z "$yazi_bin" ]; then
    echo "yazi binary not found in archive" >&2
    return 1
  fi

  $SUDO_CMD install -m 0755 "$yazi_bin" /usr/local/bin/yazi
  if [ -n "$ya_bin" ]; then
    $SUDO_CMD install -m 0755 "$ya_bin" /usr/local/bin/ya
  fi

  if ! command -v yazi >/dev/null 2>&1; then
    echo "Failed to install yazi to /usr/local/bin" >&2
    return 1
  fi
}

case "$OS" in
  Linux)
    # Only run custom Yazi install on Debian
    if [ -r /etc/os-release ]; then . /etc/os-release; fi
    if [ "${ID:-}" = "debian" ]; then
      if HAVE apt-get; then
        $SUDO_CMD apt-get update -y
        # Minimal deps for binary install/extraction
        $SUDO_CMD apt-get install -y curl ca-certificates unzip
        if ! HAVE yazi; then
          if confirm_yazi_install "GitHub prebuilt binary (Debian)"; then
            install_from_github || echo "[warn] GitHub install failed; Yazi not installed" >&2
          else
            echo "[skip] yazi install (AUTO_INSTALL not set)"
          fi
        fi
      fi
    fi
    ;;
  *)
    # No custom install on non-Debian OS
    :
    ;;
esac

echo "Yazi installation/configuration complete."


