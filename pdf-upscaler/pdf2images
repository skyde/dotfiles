#!/usr/bin/env python3
"""Extract images from a PDF (one image per page) into a folder."""

import argparse
import sys
from pathlib import Path

import fitz  # PyMuPDF


def extract_images(pdf_path: Path, output_dir: Path) -> None:
    doc = fitz.open(pdf_path)
    total = len(doc)
    pad = len(str(total))

    output_dir.mkdir(parents=True, exist_ok=True)

    for i, page in enumerate(doc):
        num = str(i + 1).zfill(pad)
        images = page.get_images(full=True)

        if images:
            # Extract the embedded image directly (best quality)
            xref = images[0][0]
            base_image = doc.extract_image(xref)
            ext = base_image["ext"]
            out_path = output_dir / f"page_{num}.{ext}"
            out_path.write_bytes(base_image["image"])
        else:
            # Fallback: render the page at high DPI
            pix = page.get_pixmap(dpi=300)
            out_path = output_dir / f"page_{num}.png"
            pix.save(str(out_path))

        print(f"[{i + 1}/{total}] {out_path.name}")

    doc.close()
    print(f"\nExtracted {total} pages to {output_dir}")


def main() -> None:
    parser = argparse.ArgumentParser(
        description="Extract images from a PDF (one image per page) into a folder."
    )
    parser.add_argument("pdf", type=Path, help="Input PDF file")
    parser.add_argument(
        "output_dir",
        type=Path,
        nargs="?",
        default=None,
        help="Output directory (default: PDF stem name)",
    )
    args = parser.parse_args()

    if not args.pdf.is_file():
        print(f"Error: {args.pdf} not found", file=sys.stderr)
        sys.exit(1)

    output_dir = args.output_dir or Path(args.pdf.stem)
    extract_images(args.pdf, output_dir)


if __name__ == "__main__":
    main()
