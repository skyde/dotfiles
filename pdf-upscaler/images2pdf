#!/usr/bin/env python3
"""Combine a folder of images into a PDF (one image per page, full-page)."""

import argparse
import sys
from pathlib import Path

from PIL import Image

IMAGE_EXTENSIONS = {".png", ".jpg", ".jpeg", ".webp", ".tiff", ".tif", ".bmp"}


def images_to_pdf(input_dir: Path, output_pdf: Path) -> None:
    files = sorted(
        f for f in input_dir.iterdir() if f.suffix.lower() in IMAGE_EXTENSIONS
    )

    if not files:
        print(f"No images found in {input_dir}", file=sys.stderr)
        sys.exit(1)

    images = []
    for f in files:
        img = Image.open(f)
        if img.mode != "RGB":
            img = img.convert("RGB")
        images.append(img)

    first, *rest = images
    first.save(output_pdf, save_all=True, append_images=rest, resolution=300.0)

    for img in images:
        img.close()

    print(f"Created {output_pdf} ({len(files)} pages)")


def main() -> None:
    parser = argparse.ArgumentParser(
        description="Combine a folder of images into a PDF (one image per page)."
    )
    parser.add_argument("input_dir", type=Path, help="Folder of images")
    parser.add_argument(
        "output_pdf",
        type=Path,
        nargs="?",
        default=None,
        help="Output PDF path (default: <input_dir>.pdf)",
    )
    args = parser.parse_args()

    if not args.input_dir.is_dir():
        print(f"Error: {args.input_dir} is not a directory", file=sys.stderr)
        sys.exit(1)

    output_pdf = args.output_pdf or Path(f"{args.input_dir}.pdf")
    images_to_pdf(args.input_dir, output_pdf)


if __name__ == "__main__":
    main()
